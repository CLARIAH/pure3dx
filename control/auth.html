<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>control.auth API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>control.auth</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L1-L317" class="git-link">Browse git</a>
</summary>
<pre><code class="python">from flask import request, session

from control.mongo import castObjectId
from control.helpers.generic import AttrDict


class Auth:
    def __init__(self, Settings, Messages, Mongo, Users, Content):
        &#34;&#34;&#34;All about authorised data access.

        This class knows users and content,
        and decides whether the current user is authorised to perform certain
        actions on content in question.

        It is instantiated by a singleton object.
        This object has a member `user` that contains the data of the current
        user if there is a current user.

        Parameters
        ----------
        Settings: `control.helpers.generic.AttrDict`
            App-wide configuration data obtained from
            `control.config.Config.Settings`.
        Messages: object
            Singleton instance of `control.messages.Messages`.
        Mongo: object
            Singleton instance of `control.mongo.Mongo`.
        Users: object
            Singleton instance of `control.users.Users`.
        Content: object
            Singleton instance of `control.content.Content`.
        &#34;&#34;&#34;
        self.Settings = Settings
        self.Messages = Messages
        Messages.debugAdd(self)
        self.Mongo = Mongo
        self.Users = Users
        self.Content = Content
        self.user = AttrDict()
        &#34;&#34;&#34;Data of the current user.

        If there is no current user, it is has no members.

        Otherwise, it has member `_id`, the mongodb id of the current user.
        It may also have additional members, such as `name` and `role`.
        &#34;&#34;&#34;

    def clearUser(self):
        &#34;&#34;&#34;Clear current user.

        The `user` member of Auth is cleard.
        Note that it is not deleted, only its members are removed.
        &#34;&#34;&#34;
        user = self.user
        user.clear()

    def getUser(self, userId):
        &#34;&#34;&#34;Get user data.

        Parameters
        ----------
        userId: ObjectId
            The id of a user in the users table of the MongoDb database.

        Returns
        -------
        boolean
            Whether a user with that id has been found.
            The data of the user record that has been found is stored
            in the `user` member of Auth.
        &#34;&#34;&#34;
        Messages = self.Messages
        Mongo = self.Mongo
        user = self.user

        user.clear()
        record = Mongo.getRecord(&#34;users&#34;, _id=castObjectId(userId))
        if record:
            user._id = userId
            user.name = record.name
            user.role = record.role
            result = True
        else:
            Messages.warning(msg=&#34;Unknown user&#34;, logmsg=f&#34;Unknown user {userId}&#34;)
            result = False
        return result

    def checkLogin(self):
        &#34;&#34;&#34;Get user data.

        Retrieves a user id from the current session, looks up the corresponding
        user, and fills the `user` member of Auth accordingly.

        In test mode, the user id is obtained from the query string.
        There is a list of test user buttons on the interface, and they
        all pass a user id in the querystring of their `href` attribute.

        In production mode, the current session will be inspected for data
        that corresponds with the logged in user.

        Returns
        -------
        boolean
            Whether a user with a valid id has been found in the current session.
        &#34;&#34;&#34;
        Settings = self.Settings
        Messages = self.Messages
        self.clearUser()
        if Settings.testMode:
            userId = request.args.get(&#34;userid&#34;, None)
            result = self.getUser(userId)
            userName = self.user.name
            if result:
                Messages.plain(msg=f&#34;LOGIN successful: user {userName}&#34;)
            else:
                Messages.warning(msg=f&#34;LOGIN: user {userId} does not exist&#34;)
            return result

        Messages.warning(msg=&#34;User management is only available in test mode&#34;)
        return False

    def authenticate(self, login=False):
        &#34;&#34;&#34;Authenticates the current user.

        Checks whether there is a current user and whether that user is fully known,
        i.e. in the users collection of the mongoDb.

        If there is a current user unknown in the database, the current user
        will be cleared.

        Parameters
        ----------
        login: boolean, optional False
            Use True to deal with a user that has just logged in.
            It will retrieve the corresponding user data from MongoDb
            and populate the `user` member of Auth.

        Returns
        -------
        boolean
            Whether the current user is authenticated.
        &#34;&#34;&#34;
        user = self.user

        if login:
            session.pop(&#34;userid&#34;, None)
            if self.checkLogin():
                session[&#34;userid&#34;] = user._id
                return True
            return False

        userId = session.get(&#34;userid&#34;, None)
        if userId:
            if not self.getUser(userId):
                self.clearUser()
                return False
            return True

        self.clearUser()
        return False

    def authenticated(self):
        &#34;&#34;&#34;Cheap check whether there is a current authenticated user.

        The `user` member of Auth is inspected: does it contain an id?
        If so, that is taken as proof that we have a valid user.

        !!! hint &#34;auhtenticate versus authenticated&#34;
            We try to enforce at all times that if there is data in the
            `user` member of Auth, it is the correct data of an authenticated
            user.
            But there may arise edge cases,
            e.g. when a user is successfully authenticated,
            but then removed from the database by an admin.

            Good practice is: in every request that needs an authenticated user:

            * call `Auth.authenticate()` the first time
            * call `authenticated` after that.

            With this practice, we can shield a lot of code with the
            cheaper `Auth.authenticated()` function.
        &#34;&#34;&#34;
        user = self.user
        return &#34;_id&#34; in user

    def deauthenticate(self):
        &#34;&#34;&#34;Logs off the current user.

        That means that the `user` memebr of Auth is cleared, and the current
        session is popped.
        &#34;&#34;&#34;
        Messages = self.Messages
        userId = session.get(&#34;userid&#34;, None)
        if userId:
            self.clearUser()
            Messages.plain(msg=&#34;logged out&#34;, logmsg=f&#34;LOGOUT successful: user {userId}&#34;)
        else:
            Messages.warning(msg=&#34;You were not logged in&#34;)

        session.pop(&#34;userid&#34;, None)

    def authorise(self, action, project=None, edition=None, byName=False):
        &#34;&#34;&#34;Authorise the current user to access a piece of content.

        !!! note &#34;Requests may come from different senders&#34;
            When 3D viewers are active, they may fire their own requests to
            this app. These 3D viewers do not know about MongoDb ids, all they
            know are the names of files and directories.

        Parameters
        ----------
        action: string
            The kind of access: `view`, `edit`, etc.
        project: string or ObjectId
            The project that is being accessed, if any.
        edition: string or ObjectId
            The edition that is being accessed, if any.
        byName: boolean, optional False
            Whether the project and edition parameters contain an ObjectId.
            If not, it is assumed they contain a name.
            Sometimes we know projects and editions by their id, especially
            when we have retrieved them from MongoDb.
            But some routes access projects and editions on the file system,
            and then we have only their names.
            This happens in case the 3D viewers access the file system directly.

        Returns
        -------
        boolean
            Whether the current user is authorised.
        &#34;&#34;&#34;
        Settings = self.Settings
        Mongo = self.Mongo

        user = self.user

        if project:
            projectId = (
                Mongo.getRecord(&#34;projects&#34;, name=project)._id
                if byName
                else project or None
            )
        else:
            projectId = None

        if edition:
            editionId = (
                Mongo.getRecord(&#34;editions&#34;, name=edition)._id
                if byName
                else edition or None
            )
        else:
            editionId = None

        if projectId is None:
            projectId = Mongo.getRecord(&#34;editions&#34;, _id=editionId).projectId

        projectRole = (
            None
            if user._id is None
            else Mongo.getRecord(
                &#34;projectUsers&#34;, projectId=projectId, userId=castObjectId(user._id)
            ).role
        )
        projectPub = (
            &#34;published&#34;
            if Mongo.getRecord(&#34;projects&#34;, _id=projectId).isPublished
            else &#34;unpublished&#34;
        )

        projectRules = Settings.auth.projectRules[projectPub]
        condition = (
            projectRules[user.role] if user.role in projectRules else projectRules[None]
        ).get(action, False)
        permission = condition if type(condition) is bool else projectRole in condition
        return permission

    def isModifiable(self, projectId, editionId):
        &#34;&#34;&#34;Whether the current user may modify content.

        The content may be outside any project
        (both `projectId` and `editionId` are None),
        within a project but outside any edition (`editionId` is None),
        or within an edition (`editionId` is not None).

        Parameters
        ----------
        projectId: ObjectId or None
            MongoDB id of the project in question.
        editionId: ObjectId or None
            MongoDB id of the edition in question.
        &#34;&#34;&#34;
        return self.authorise(&#34;edit&#34;, project=projectId, edition=editionId)

    def checkModifiable(self, projectId, editionId, action):
        &#34;&#34;&#34;Like `Auth.isModifiable()`, but returns an allowed action.

        This function &#34;demotes&#34; an action to an allowed action if the
        action itself is not allowed.

        Parameters
        ----------
        action: string
            An intended action.

        Returns
        -------
        string
            If the action is a modifying action, but the content is not modifiable,
            it returns `view`.
            Otherwise it returns the action itself.
        &#34;&#34;&#34;
        if action != &#34;view&#34;:
            if not self.isModifiable(projectId, editionId):
                action = &#34;view&#34;
        return action</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="control.auth.Auth"><code class="flex name class">
<span>class <span class="ident">Auth</span></span>
<span>(</span><span>Settings, Messages, Mongo, Users, Content)</span>
</code></dt>
<dd>
<div class="desc"><p>All about authorised data access.</p>
<p>This class knows users and content,
and decides whether the current user is authorised to perform certain
actions on content in question.</p>
<p>It is instantiated by a singleton object.
This object has a member <code>user</code> that contains the data of the current
user if there is a current user.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>Settings</code></strong> :&ensp;<code><a title="control.helpers.generic.AttrDict" href="helpers/generic.html#control.helpers.generic.AttrDict">AttrDict</a></code></dt>
<dd>App-wide configuration data obtained from
<code><a title="control.config.Config.Settings" href="config.html#control.config.Config.Settings">Config.Settings</a></code>.</dd>
<dt><strong><code>Messages</code></strong> :&ensp;<code>object</code></dt>
<dd>Singleton instance of <code><a title="control.messages.Messages" href="messages.html#control.messages.Messages">Messages</a></code>.</dd>
<dt><strong><code>Mongo</code></strong> :&ensp;<code>object</code></dt>
<dd>Singleton instance of <code><a title="control.mongo.Mongo" href="mongo.html#control.mongo.Mongo">Mongo</a></code>.</dd>
<dt><strong><code>Users</code></strong> :&ensp;<code>object</code></dt>
<dd>Singleton instance of <code><a title="control.users.Users" href="users.html#control.users.Users">Users</a></code>.</dd>
<dt><strong><code>Content</code></strong> :&ensp;<code>object</code></dt>
<dd>Singleton instance of <code><a title="control.content.Content" href="content.html#control.content.Content">Content</a></code>.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L7-L317" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class Auth:
    def __init__(self, Settings, Messages, Mongo, Users, Content):
        &#34;&#34;&#34;All about authorised data access.

        This class knows users and content,
        and decides whether the current user is authorised to perform certain
        actions on content in question.

        It is instantiated by a singleton object.
        This object has a member `user` that contains the data of the current
        user if there is a current user.

        Parameters
        ----------
        Settings: `control.helpers.generic.AttrDict`
            App-wide configuration data obtained from
            `control.config.Config.Settings`.
        Messages: object
            Singleton instance of `control.messages.Messages`.
        Mongo: object
            Singleton instance of `control.mongo.Mongo`.
        Users: object
            Singleton instance of `control.users.Users`.
        Content: object
            Singleton instance of `control.content.Content`.
        &#34;&#34;&#34;
        self.Settings = Settings
        self.Messages = Messages
        Messages.debugAdd(self)
        self.Mongo = Mongo
        self.Users = Users
        self.Content = Content
        self.user = AttrDict()
        &#34;&#34;&#34;Data of the current user.

        If there is no current user, it is has no members.

        Otherwise, it has member `_id`, the mongodb id of the current user.
        It may also have additional members, such as `name` and `role`.
        &#34;&#34;&#34;

    def clearUser(self):
        &#34;&#34;&#34;Clear current user.

        The `user` member of Auth is cleard.
        Note that it is not deleted, only its members are removed.
        &#34;&#34;&#34;
        user = self.user
        user.clear()

    def getUser(self, userId):
        &#34;&#34;&#34;Get user data.

        Parameters
        ----------
        userId: ObjectId
            The id of a user in the users table of the MongoDb database.

        Returns
        -------
        boolean
            Whether a user with that id has been found.
            The data of the user record that has been found is stored
            in the `user` member of Auth.
        &#34;&#34;&#34;
        Messages = self.Messages
        Mongo = self.Mongo
        user = self.user

        user.clear()
        record = Mongo.getRecord(&#34;users&#34;, _id=castObjectId(userId))
        if record:
            user._id = userId
            user.name = record.name
            user.role = record.role
            result = True
        else:
            Messages.warning(msg=&#34;Unknown user&#34;, logmsg=f&#34;Unknown user {userId}&#34;)
            result = False
        return result

    def checkLogin(self):
        &#34;&#34;&#34;Get user data.

        Retrieves a user id from the current session, looks up the corresponding
        user, and fills the `user` member of Auth accordingly.

        In test mode, the user id is obtained from the query string.
        There is a list of test user buttons on the interface, and they
        all pass a user id in the querystring of their `href` attribute.

        In production mode, the current session will be inspected for data
        that corresponds with the logged in user.

        Returns
        -------
        boolean
            Whether a user with a valid id has been found in the current session.
        &#34;&#34;&#34;
        Settings = self.Settings
        Messages = self.Messages
        self.clearUser()
        if Settings.testMode:
            userId = request.args.get(&#34;userid&#34;, None)
            result = self.getUser(userId)
            userName = self.user.name
            if result:
                Messages.plain(msg=f&#34;LOGIN successful: user {userName}&#34;)
            else:
                Messages.warning(msg=f&#34;LOGIN: user {userId} does not exist&#34;)
            return result

        Messages.warning(msg=&#34;User management is only available in test mode&#34;)
        return False

    def authenticate(self, login=False):
        &#34;&#34;&#34;Authenticates the current user.

        Checks whether there is a current user and whether that user is fully known,
        i.e. in the users collection of the mongoDb.

        If there is a current user unknown in the database, the current user
        will be cleared.

        Parameters
        ----------
        login: boolean, optional False
            Use True to deal with a user that has just logged in.
            It will retrieve the corresponding user data from MongoDb
            and populate the `user` member of Auth.

        Returns
        -------
        boolean
            Whether the current user is authenticated.
        &#34;&#34;&#34;
        user = self.user

        if login:
            session.pop(&#34;userid&#34;, None)
            if self.checkLogin():
                session[&#34;userid&#34;] = user._id
                return True
            return False

        userId = session.get(&#34;userid&#34;, None)
        if userId:
            if not self.getUser(userId):
                self.clearUser()
                return False
            return True

        self.clearUser()
        return False

    def authenticated(self):
        &#34;&#34;&#34;Cheap check whether there is a current authenticated user.

        The `user` member of Auth is inspected: does it contain an id?
        If so, that is taken as proof that we have a valid user.

        !!! hint &#34;auhtenticate versus authenticated&#34;
            We try to enforce at all times that if there is data in the
            `user` member of Auth, it is the correct data of an authenticated
            user.
            But there may arise edge cases,
            e.g. when a user is successfully authenticated,
            but then removed from the database by an admin.

            Good practice is: in every request that needs an authenticated user:

            * call `Auth.authenticate()` the first time
            * call `authenticated` after that.

            With this practice, we can shield a lot of code with the
            cheaper `Auth.authenticated()` function.
        &#34;&#34;&#34;
        user = self.user
        return &#34;_id&#34; in user

    def deauthenticate(self):
        &#34;&#34;&#34;Logs off the current user.

        That means that the `user` memebr of Auth is cleared, and the current
        session is popped.
        &#34;&#34;&#34;
        Messages = self.Messages
        userId = session.get(&#34;userid&#34;, None)
        if userId:
            self.clearUser()
            Messages.plain(msg=&#34;logged out&#34;, logmsg=f&#34;LOGOUT successful: user {userId}&#34;)
        else:
            Messages.warning(msg=&#34;You were not logged in&#34;)

        session.pop(&#34;userid&#34;, None)

    def authorise(self, action, project=None, edition=None, byName=False):
        &#34;&#34;&#34;Authorise the current user to access a piece of content.

        !!! note &#34;Requests may come from different senders&#34;
            When 3D viewers are active, they may fire their own requests to
            this app. These 3D viewers do not know about MongoDb ids, all they
            know are the names of files and directories.

        Parameters
        ----------
        action: string
            The kind of access: `view`, `edit`, etc.
        project: string or ObjectId
            The project that is being accessed, if any.
        edition: string or ObjectId
            The edition that is being accessed, if any.
        byName: boolean, optional False
            Whether the project and edition parameters contain an ObjectId.
            If not, it is assumed they contain a name.
            Sometimes we know projects and editions by their id, especially
            when we have retrieved them from MongoDb.
            But some routes access projects and editions on the file system,
            and then we have only their names.
            This happens in case the 3D viewers access the file system directly.

        Returns
        -------
        boolean
            Whether the current user is authorised.
        &#34;&#34;&#34;
        Settings = self.Settings
        Mongo = self.Mongo

        user = self.user

        if project:
            projectId = (
                Mongo.getRecord(&#34;projects&#34;, name=project)._id
                if byName
                else project or None
            )
        else:
            projectId = None

        if edition:
            editionId = (
                Mongo.getRecord(&#34;editions&#34;, name=edition)._id
                if byName
                else edition or None
            )
        else:
            editionId = None

        if projectId is None:
            projectId = Mongo.getRecord(&#34;editions&#34;, _id=editionId).projectId

        projectRole = (
            None
            if user._id is None
            else Mongo.getRecord(
                &#34;projectUsers&#34;, projectId=projectId, userId=castObjectId(user._id)
            ).role
        )
        projectPub = (
            &#34;published&#34;
            if Mongo.getRecord(&#34;projects&#34;, _id=projectId).isPublished
            else &#34;unpublished&#34;
        )

        projectRules = Settings.auth.projectRules[projectPub]
        condition = (
            projectRules[user.role] if user.role in projectRules else projectRules[None]
        ).get(action, False)
        permission = condition if type(condition) is bool else projectRole in condition
        return permission

    def isModifiable(self, projectId, editionId):
        &#34;&#34;&#34;Whether the current user may modify content.

        The content may be outside any project
        (both `projectId` and `editionId` are None),
        within a project but outside any edition (`editionId` is None),
        or within an edition (`editionId` is not None).

        Parameters
        ----------
        projectId: ObjectId or None
            MongoDB id of the project in question.
        editionId: ObjectId or None
            MongoDB id of the edition in question.
        &#34;&#34;&#34;
        return self.authorise(&#34;edit&#34;, project=projectId, edition=editionId)

    def checkModifiable(self, projectId, editionId, action):
        &#34;&#34;&#34;Like `Auth.isModifiable()`, but returns an allowed action.

        This function &#34;demotes&#34; an action to an allowed action if the
        action itself is not allowed.

        Parameters
        ----------
        action: string
            An intended action.

        Returns
        -------
        string
            If the action is a modifying action, but the content is not modifiable,
            it returns `view`.
            Otherwise it returns the action itself.
        &#34;&#34;&#34;
        if action != &#34;view&#34;:
            if not self.isModifiable(projectId, editionId):
                action = &#34;view&#34;
        return action</code></pre>
</details>
<h3>Instance variables</h3>
<dl>
<dt id="control.auth.Auth.user"><code class="name">var <span class="ident">user</span></code></dt>
<dd>
<div class="desc"><p>Data of the current user.</p>
<p>If there is no current user, it is has no members.</p>
<p>Otherwise, it has member <code>_id</code>, the mongodb id of the current user.
It may also have additional members, such as <code>name</code> and <code>role</code>.</p></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="control.auth.Auth.authenticate"><code class="name flex">
<span>def <span class="ident">authenticate</span></span>(<span>self, login=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Authenticates the current user.</p>
<p>Checks whether there is a current user and whether that user is fully known,
i.e. in the users collection of the mongoDb.</p>
<p>If there is a current user unknown in the database, the current user
will be cleared.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>login</code></strong> :&ensp;<code>boolean</code>, optional <code>False</code></dt>
<dd>Use True to deal with a user that has just logged in.
It will retrieve the corresponding user data from MongoDb
and populate the <code>user</code> member of Auth.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>boolean</code></dt>
<dd>Whether the current user is authenticated.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L122-L160" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def authenticate(self, login=False):
    &#34;&#34;&#34;Authenticates the current user.

    Checks whether there is a current user and whether that user is fully known,
    i.e. in the users collection of the mongoDb.

    If there is a current user unknown in the database, the current user
    will be cleared.

    Parameters
    ----------
    login: boolean, optional False
        Use True to deal with a user that has just logged in.
        It will retrieve the corresponding user data from MongoDb
        and populate the `user` member of Auth.

    Returns
    -------
    boolean
        Whether the current user is authenticated.
    &#34;&#34;&#34;
    user = self.user

    if login:
        session.pop(&#34;userid&#34;, None)
        if self.checkLogin():
            session[&#34;userid&#34;] = user._id
            return True
        return False

    userId = session.get(&#34;userid&#34;, None)
    if userId:
        if not self.getUser(userId):
            self.clearUser()
            return False
        return True

    self.clearUser()
    return False</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.authenticated"><code class="name flex">
<span>def <span class="ident">authenticated</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Cheap check whether there is a current authenticated user.</p>
<p>The <code>user</code> member of Auth is inspected: does it contain an id?
If so, that is taken as proof that we have a valid user.</p>
<div class="admonition hint">
<p class="admonition-title">auhtenticate versus authenticated</p>
<p>We try to enforce at all times that if there is data in the
<code>user</code> member of Auth, it is the correct data of an authenticated
user.
But there may arise edge cases,
e.g. when a user is successfully authenticated,
but then removed from the database by an admin.</p>
<p>Good practice is: in every request that needs an authenticated user:</p>
<ul>
<li>call <code><a title="control.auth.Auth.authenticate" href="#control.auth.Auth.authenticate">Auth.authenticate()</a></code> the first time</li>
<li>call <code>authenticated</code> after that.</li>
</ul>
<p>With this practice, we can shield a lot of code with the
cheaper <code><a title="control.auth.Auth.authenticated" href="#control.auth.Auth.authenticated">Auth.authenticated()</a></code> function.</p>
</div></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L162-L185" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def authenticated(self):
    &#34;&#34;&#34;Cheap check whether there is a current authenticated user.

    The `user` member of Auth is inspected: does it contain an id?
    If so, that is taken as proof that we have a valid user.

    !!! hint &#34;auhtenticate versus authenticated&#34;
        We try to enforce at all times that if there is data in the
        `user` member of Auth, it is the correct data of an authenticated
        user.
        But there may arise edge cases,
        e.g. when a user is successfully authenticated,
        but then removed from the database by an admin.

        Good practice is: in every request that needs an authenticated user:

        * call `Auth.authenticate()` the first time
        * call `authenticated` after that.

        With this practice, we can shield a lot of code with the
        cheaper `Auth.authenticated()` function.
    &#34;&#34;&#34;
    user = self.user
    return &#34;_id&#34; in user</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.authorise"><code class="name flex">
<span>def <span class="ident">authorise</span></span>(<span>self, action, project=None, edition=None, byName=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Authorise the current user to access a piece of content.</p>
<div class="admonition note">
<p class="admonition-title">Requests may come from different senders</p>
<p>When 3D viewers are active, they may fire their own requests to
this app. These 3D viewers do not know about MongoDb ids, all they
know are the names of files and directories.</p>
</div>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>action</code></strong> :&ensp;<code>string</code></dt>
<dd>The kind of access: <code>view</code>, <code>edit</code>, etc.</dd>
<dt><strong><code>project</code></strong> :&ensp;<code>string</code> or <code>ObjectId</code></dt>
<dd>The project that is being accessed, if any.</dd>
<dt><strong><code>edition</code></strong> :&ensp;<code>string</code> or <code>ObjectId</code></dt>
<dd>The edition that is being accessed, if any.</dd>
<dt><strong><code>byName</code></strong> :&ensp;<code>boolean</code>, optional <code>False</code></dt>
<dd>Whether the project and edition parameters contain an ObjectId.
If not, it is assumed they contain a name.
Sometimes we know projects and editions by their id, especially
when we have retrieved them from MongoDb.
But some routes access projects and editions on the file system,
and then we have only their names.
This happens in case the 3D viewers access the file system directly.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>boolean</code></dt>
<dd>Whether the current user is authorised.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L203-L277" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def authorise(self, action, project=None, edition=None, byName=False):
    &#34;&#34;&#34;Authorise the current user to access a piece of content.

    !!! note &#34;Requests may come from different senders&#34;
        When 3D viewers are active, they may fire their own requests to
        this app. These 3D viewers do not know about MongoDb ids, all they
        know are the names of files and directories.

    Parameters
    ----------
    action: string
        The kind of access: `view`, `edit`, etc.
    project: string or ObjectId
        The project that is being accessed, if any.
    edition: string or ObjectId
        The edition that is being accessed, if any.
    byName: boolean, optional False
        Whether the project and edition parameters contain an ObjectId.
        If not, it is assumed they contain a name.
        Sometimes we know projects and editions by their id, especially
        when we have retrieved them from MongoDb.
        But some routes access projects and editions on the file system,
        and then we have only their names.
        This happens in case the 3D viewers access the file system directly.

    Returns
    -------
    boolean
        Whether the current user is authorised.
    &#34;&#34;&#34;
    Settings = self.Settings
    Mongo = self.Mongo

    user = self.user

    if project:
        projectId = (
            Mongo.getRecord(&#34;projects&#34;, name=project)._id
            if byName
            else project or None
        )
    else:
        projectId = None

    if edition:
        editionId = (
            Mongo.getRecord(&#34;editions&#34;, name=edition)._id
            if byName
            else edition or None
        )
    else:
        editionId = None

    if projectId is None:
        projectId = Mongo.getRecord(&#34;editions&#34;, _id=editionId).projectId

    projectRole = (
        None
        if user._id is None
        else Mongo.getRecord(
            &#34;projectUsers&#34;, projectId=projectId, userId=castObjectId(user._id)
        ).role
    )
    projectPub = (
        &#34;published&#34;
        if Mongo.getRecord(&#34;projects&#34;, _id=projectId).isPublished
        else &#34;unpublished&#34;
    )

    projectRules = Settings.auth.projectRules[projectPub]
    condition = (
        projectRules[user.role] if user.role in projectRules else projectRules[None]
    ).get(action, False)
    permission = condition if type(condition) is bool else projectRole in condition
    return permission</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.checkLogin"><code class="name flex">
<span>def <span class="ident">checkLogin</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Get user data.</p>
<p>Retrieves a user id from the current session, looks up the corresponding
user, and fills the <code>user</code> member of Auth accordingly.</p>
<p>In test mode, the user id is obtained from the query string.
There is a list of test user buttons on the interface, and they
all pass a user id in the querystring of their <code>href</code> attribute.</p>
<p>In production mode, the current session will be inspected for data
that corresponds with the logged in user.</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>boolean</code></dt>
<dd>Whether a user with a valid id has been found in the current session.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L88-L120" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def checkLogin(self):
    &#34;&#34;&#34;Get user data.

    Retrieves a user id from the current session, looks up the corresponding
    user, and fills the `user` member of Auth accordingly.

    In test mode, the user id is obtained from the query string.
    There is a list of test user buttons on the interface, and they
    all pass a user id in the querystring of their `href` attribute.

    In production mode, the current session will be inspected for data
    that corresponds with the logged in user.

    Returns
    -------
    boolean
        Whether a user with a valid id has been found in the current session.
    &#34;&#34;&#34;
    Settings = self.Settings
    Messages = self.Messages
    self.clearUser()
    if Settings.testMode:
        userId = request.args.get(&#34;userid&#34;, None)
        result = self.getUser(userId)
        userName = self.user.name
        if result:
            Messages.plain(msg=f&#34;LOGIN successful: user {userName}&#34;)
        else:
            Messages.warning(msg=f&#34;LOGIN: user {userId} does not exist&#34;)
        return result

    Messages.warning(msg=&#34;User management is only available in test mode&#34;)
    return False</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.checkModifiable"><code class="name flex">
<span>def <span class="ident">checkModifiable</span></span>(<span>self, projectId, editionId, action)</span>
</code></dt>
<dd>
<div class="desc"><p>Like <code><a title="control.auth.Auth.isModifiable" href="#control.auth.Auth.isModifiable">Auth.isModifiable()</a></code>, but returns an allowed action.</p>
<p>This function "demotes" an action to an allowed action if the
action itself is not allowed.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>action</code></strong> :&ensp;<code>string</code></dt>
<dd>An intended action.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>string</code></dt>
<dd>If the action is a modifying action, but the content is not modifiable,
it returns <code>view</code>.
Otherwise it returns the action itself.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L296-L317" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def checkModifiable(self, projectId, editionId, action):
    &#34;&#34;&#34;Like `Auth.isModifiable()`, but returns an allowed action.

    This function &#34;demotes&#34; an action to an allowed action if the
    action itself is not allowed.

    Parameters
    ----------
    action: string
        An intended action.

    Returns
    -------
    string
        If the action is a modifying action, but the content is not modifiable,
        it returns `view`.
        Otherwise it returns the action itself.
    &#34;&#34;&#34;
    if action != &#34;view&#34;:
        if not self.isModifiable(projectId, editionId):
            action = &#34;view&#34;
    return action</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.clearUser"><code class="name flex">
<span>def <span class="ident">clearUser</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Clear current user.</p>
<p>The <code>user</code> member of Auth is cleard.
Note that it is not deleted, only its members are removed.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L48-L55" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def clearUser(self):
    &#34;&#34;&#34;Clear current user.

    The `user` member of Auth is cleard.
    Note that it is not deleted, only its members are removed.
    &#34;&#34;&#34;
    user = self.user
    user.clear()</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.deauthenticate"><code class="name flex">
<span>def <span class="ident">deauthenticate</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Logs off the current user.</p>
<p>That means that the <code>user</code> memebr of Auth is cleared, and the current
session is popped.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L187-L201" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def deauthenticate(self):
    &#34;&#34;&#34;Logs off the current user.

    That means that the `user` memebr of Auth is cleared, and the current
    session is popped.
    &#34;&#34;&#34;
    Messages = self.Messages
    userId = session.get(&#34;userid&#34;, None)
    if userId:
        self.clearUser()
        Messages.plain(msg=&#34;logged out&#34;, logmsg=f&#34;LOGOUT successful: user {userId}&#34;)
    else:
        Messages.warning(msg=&#34;You were not logged in&#34;)

    session.pop(&#34;userid&#34;, None)</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.getUser"><code class="name flex">
<span>def <span class="ident">getUser</span></span>(<span>self, userId)</span>
</code></dt>
<dd>
<div class="desc"><p>Get user data.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>userId</code></strong> :&ensp;<code>ObjectId</code></dt>
<dd>The id of a user in the users table of the MongoDb database.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>boolean</code></dt>
<dd>Whether a user with that id has been found.
The data of the user record that has been found is stored
in the <code>user</code> member of Auth.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L57-L86" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def getUser(self, userId):
    &#34;&#34;&#34;Get user data.

    Parameters
    ----------
    userId: ObjectId
        The id of a user in the users table of the MongoDb database.

    Returns
    -------
    boolean
        Whether a user with that id has been found.
        The data of the user record that has been found is stored
        in the `user` member of Auth.
    &#34;&#34;&#34;
    Messages = self.Messages
    Mongo = self.Mongo
    user = self.user

    user.clear()
    record = Mongo.getRecord(&#34;users&#34;, _id=castObjectId(userId))
    if record:
        user._id = userId
        user.name = record.name
        user.role = record.role
        result = True
    else:
        Messages.warning(msg=&#34;Unknown user&#34;, logmsg=f&#34;Unknown user {userId}&#34;)
        result = False
    return result</code></pre>
</details>
</dd>
<dt id="control.auth.Auth.isModifiable"><code class="name flex">
<span>def <span class="ident">isModifiable</span></span>(<span>self, projectId, editionId)</span>
</code></dt>
<dd>
<div class="desc"><p>Whether the current user may modify content.</p>
<p>The content may be outside any project
(both <code>projectId</code> and <code>editionId</code> are None),
within a project but outside any edition (<code>editionId</code> is None),
or within an edition (<code>editionId</code> is not None).</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>projectId</code></strong> :&ensp;<code>ObjectId</code> or <code>None</code></dt>
<dd>MongoDB id of the project in question.</dd>
<dt><strong><code>editionId</code></strong> :&ensp;<code>ObjectId</code> or <code>None</code></dt>
<dd>MongoDB id of the edition in question.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/CLARIAH/pure3dx/blob/5948f0757efdfdd0b019d9d5582f265e8b31e9f2/src/pure3d/control/auth.py#L279-L294" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def isModifiable(self, projectId, editionId):
    &#34;&#34;&#34;Whether the current user may modify content.

    The content may be outside any project
    (both `projectId` and `editionId` are None),
    within a project but outside any edition (`editionId` is None),
    or within an edition (`editionId` is not None).

    Parameters
    ----------
    projectId: ObjectId or None
        MongoDB id of the project in question.
    editionId: ObjectId or None
        MongoDB id of the edition in question.
    &#34;&#34;&#34;
    return self.authorise(&#34;edit&#34;, project=projectId, edition=editionId)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<p><a href="https://github.com/CLARIAH/pure3dx" title="GitHub repo">GitHub</a></p>
<form>
<input id="lunr-search" name="q" placeholder="🔎 Search ..." aria-label="Search"
disabled minlength="2">
</form>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.css" integrity="sha512-j1u8eUJ4f23xPPxwOrLUPQaCD2dwzNqqmDDcWS4deWsMv2ohLqmXXuP3hU7g8TyzbMSakP/mMqoNBYWj8AEIFg==" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.js" integrity="sha512-plGUER9JkeEWPPqQBE4sdLqBoQug5Ap+BCGMc7bJ8BXkm+VVj6QzkpBz5Yv2yPkkq+cqg9IpkBaGCas6uDbW8g==" crossorigin></script>
<style>
.modal-dialog iframe {
width: 100vw;
height: calc(100vh - 80px);
}
@media screen and (min-width: 700px) {
.modal-dialog iframe {
width: 70vw;
height: 80vh;
}
}
.modal-dialog .tingle-modal-box {width: auto;}
.modal-dialog .tingle-modal-box__content {padding: 0;}
</style>
<script>
const input = document.getElementById('lunr-search');
input.disabled = false;
input.form.addEventListener('submit', (ev) => {
ev.preventDefault();
const url = new URL(window.location);
url.searchParams.set('q', input.value);
history.replaceState({}, null, url.toString());
search(input.value);
});
const query = new URL(window.location).searchParams.get('q');
if (query)
search(query);
function search(query) {
const url = '../doc-search.html#' + encodeURIComponent(query);
new tingle.modal({
cssClass: ['modal-dialog'],
onClose: () => {
const url = new URL(window.location);
url.searchParams.delete('q');
history.replaceState({}, null, url.toString());
setTimeout(() => input.focus(), 100);
}
}).setContent('<iframe src="' + url + '"></iframe>').open();
}
</script>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="control" href="index.html">control</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="control.auth.Auth" href="#control.auth.Auth">Auth</a></code></h4>
<ul class="two-column">
<li><code><a title="control.auth.Auth.authenticate" href="#control.auth.Auth.authenticate">authenticate</a></code></li>
<li><code><a title="control.auth.Auth.authenticated" href="#control.auth.Auth.authenticated">authenticated</a></code></li>
<li><code><a title="control.auth.Auth.authorise" href="#control.auth.Auth.authorise">authorise</a></code></li>
<li><code><a title="control.auth.Auth.checkLogin" href="#control.auth.Auth.checkLogin">checkLogin</a></code></li>
<li><code><a title="control.auth.Auth.checkModifiable" href="#control.auth.Auth.checkModifiable">checkModifiable</a></code></li>
<li><code><a title="control.auth.Auth.clearUser" href="#control.auth.Auth.clearUser">clearUser</a></code></li>
<li><code><a title="control.auth.Auth.deauthenticate" href="#control.auth.Auth.deauthenticate">deauthenticate</a></code></li>
<li><code><a title="control.auth.Auth.getUser" href="#control.auth.Auth.getUser">getUser</a></code></li>
<li><code><a title="control.auth.Auth.isModifiable" href="#control.auth.Auth.isModifiable">isModifiable</a></code></li>
<li><code><a title="control.auth.Auth.user" href="#control.auth.Auth.user">user</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<a href="https://pure.knaw.nl/portal/en/persons/dirk-roorda">Dirk Roorda</a>
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>